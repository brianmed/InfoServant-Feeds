<!DOCTYPE html>
<html>
<head>
    <title>InfoServant</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/jmobile/jquery.mobile-1.3.1.min.css" />
    <script src="/jquery-1.10.1.min.js"></script>
    <script src="/jmobile/jquery.mobile-1.3.1.min.js"></script>
</head>
<body>

[% UNLESS account_verified %]
<div data-role="page">

    <div data-role="header">
        <h1>InfoServant</h1>
    </div><!-- /header -->

    <div data-role="content">
            <form action="/dashboard" method="post">
                <input type=hidden name=method value=verify>
                <input name="verify" id="verify" placeholder="Verification Number" value="[% verify || c.session.verify | html %]" type="text" autocapitalize="off">
                <input value="Verify" data-theme="b" type="submit">
            </form>
    </div><!-- /content -->

    <div data-role="footer" data-id="foo1" data-position="fixed">
    <div data-role="navbar">
        <ul>
            <li><a href="/logout" data-rel="external">Logout</a></li>
            <li><a href="mailto:support@infoservant.com">Contact</a></li>
        </ul>
    </div><!-- /navbar -->
</div><!-- /footer -->
</div><!-- /page -->
[% END %]

[% IF account_verified %]
<div data-role="page" class=ui-responsive-panel>

    <div data-role="header">
        <h1>[% IF cur_title %] [% cur_title %] [% ELSE %] Entries [% END %]</h1>
        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
        <a href="#profile-form" data-icon="plus" data-iconpos="notext">Proflie</a>
    </div><!-- /header -->

    <div data-role="content">
        [% UNLESS have_entries %]
        Please upload an opml file or add a rss feed.
        [% END %]

        [% IF have_entries %]
            <ul data-role="listview">
                [% FOREACH entry IN entries %]
                    [% IF cur_date != entry.date %]
                        [% SET cur_date = entry.date %]
                        <li data-role="list-divider">[% cur_date %]</li>
                    [% END %]
                <li><a data-rel=external href="/dashboard/details?entry_id=[% entry.id %]&feed_id=[% entry.feed_id %]">
                    [% IF c.session.cur_feed %]
                        <p class="ui-li-desc" style="white-space: normal;"><strong>[% entry.title %]</strong></p>
                    [% ELSE %]
                        <h2>[% entry.feed_title %]</h2>
                        <p><strong>[% entry.title %]</strong></p>
                    [% END %]
                    <!-- <p>More summary here</p> -->
                </a></li>
                [% END %]
            </ul>
        [% END %]
    </div><!-- /content -->

            <style>
                .nav-search .ui-btn-up-a {
                    background-image:none;
                    background-color:#333333;
                }
                .nav-search .ui-btn-inner {
                    border-top: 1px solid #888;
                    border-color: rgba(255, 255, 255, .1);
                }
            </style>

                <div data-role="panel" data-position="left" data-position-fixed="false" data-display="reveal" id="nav-panel" data-theme="a">

                    <ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
                        <li data-icon="delete" style="background-color:#111;">
                            <a href="#" data-rel="close">Close menu</a>
                        </li>
                        [% IF c.session.cur_feed %]
                        <li data-filtertext="wai-aria voiceover accessibility screen reader">
                            <a href="/dashboard?feed=-1">All Feeds</a>
                        </li>
                        [% END %]
                        [% IF have_feeds %]
                        [% FOREACH feed IN feeds %]
                        <li data-filtertext="wai-aria voiceover accessibility screen reader">
                            <a href="/dashboard?feed=[% feed.id %]">[% feed.name | html %]</a>
                        </li>
                        [% END %]
                        [% END %]
                    </ul>

                    <!-- panel content goes here -->
                </div><!-- /panel -->

                <div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="profile-form" data-theme="b">
                    <h2>Profile</h2>

                    <form action="/dashboard" method=post>
                        <input type=hidden name=method value=new_feed>
                        <input type="text" placeholder="http://website.com/rss" value="" name="new_feed" data-clear-btn="true" class="ui-input-text ui-body-c">
                        <input value="Add" data-theme="b" type="submit">
                    </form>

                    [% UNLESS c.is_mobile %]
                    <form action="/dashboard" data-ajax="false" enctype="multipart/form-data" method="post">
                        <input type=hidden name=method value=opml_file>
                        <input data-clear-btn="true" name="opml_file" type="file">
                        <input value="Upload" data-theme="b" type="submit">
                    </form>
                    [% END %]

                    [% IF c.session.cur_feed %]
                    <form action="/dashboard" method=post>
                        <input type=hidden name=method value=unsubscribe>
                        <input value="Unsubscribe" data-theme="b" type="submit">
                    </form>
                    [% END %]

                    <a href="#" data-rel="close" data-role="button" data-theme="c" data-mini="true">Cancel</a>

                    <!-- panel content goes here -->
                </div><!-- /panel -->

    <div data-role="footer" data-id="foo1" data-position="fixed">
    <div data-role="navbar">
        <ul>
            [% IF have_entries %]
                [% IF offset %]
                    [% SET page_prev = offset - 30 %]

                    [% IF page_prev > 0 %]
                        <li><a style="pointer-events: none; cursor: default" href="/dashboard" data-rel="external" data-ajax=false>Prev</a></li>
                    [% ELSE %]
                        <li><a href="/dashboard?offset=[% page_prev %]" data-rel="external" data-ajax=false>Prev</a></li>
                    [% END %]
                [% END %]
            [% END %]
            <li><a href="/logout" data-rel="external">Logout</a></li>
            <li><a href="/dashboard" data-rel="external" data-ajax=false>Refresh</a></li>
            <!-- <li><a href="mailto:support@infoservant.com">Contact</a></li> -->

            [% IF have_entries %]
                [% SET page_next = offset + 30 %]
                <li><a href="/dashboard?offset=[% page_next %]" data-rel="external" data-ajax=false>Next</a></li>
            [% END %]
        </ul>
    </div><!-- /navbar -->
</div><!-- /footer -->
</div><!-- /page -->

</body>
</html>

[% STOP %]

<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <script src="jquery-1.10.1.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    [% UNLESS h.is_mobile %]
	<script src="/viewer/tinymce/js/tinymce/tinymce.min.js"></script>
    [% END %]
</head>
<body>

  <div class="navbar navbar-inverse">
    <div class="navbar-inner">
      <div class="container">
        <a class="brand visible-desktop hidden-phone hidden-tablet" href="/">InfoServant</a>
          <ul class="nav pull-right visible-desktop hidden-phone hidden-tablet">
            <li><a href="/logout">Logout</a></li>
            <li><a href="mailto:support@infoservant.com">Contact</a></li>
          </ul>
          <ul class="nav hidden-desktop visible-phone visible-tablet">
            <li><a href="/logout">Logout</a></li>
            <li><a href="mailto:support@infoservant.com">Contact</a></li>
          </ul>
      </div>
    </div><!-- /navbar-inner -->
  </div><!-- /navbar -->


    <div class="tabbable"> <!-- Only required for left/right tabs -->
    <ul id="main_tab" class="nav nav-tabs">
    <li class="active"><a href="#tab_entries" data-toggle="tab">Entries</a></li>
    <li><a href="#tab_feeds" data-toggle="tab">Feeds</a></li>
    <li><a href="#tab_profile" data-toggle="tab">Profile</a></li>
    </ul>
    <div class="tab-content">
    <div class="tab-pane active" id="tab_entries">

            <ul id=the_entries class="nav nav-list">
              [% IF have_entries %]
              [% FOREACH entry IN entries %]
              <li><a href='javascript:void(0)' onClick="showEntry(this, [% entry.feed_id %],  '[% entry.entry_id %]');">[% entry.title | html %]</a></li>
              [% END %]
              [% END %]
            </ul>

            [% IF have_entries %]
            [% UNLESS offset %]
            <button class="btn btn-primary disabled">Prev</button>
            [% END %]
            [% IF offset %]
            [% SET page_prev = offset - 30 %]
            <button class="btn btn-primary" onClick="javascript:location.href = '/dashboard?offset=[% page_prev %]'; location.reload;">Prev</button>
            [% END %]
            [% SET page_next = offset + 30 %]
            <button class="btn btn-primary" onClick="javascript:location.href = '/dashboard?offset=[% page_next %]'; location.reload;">Next</button>
            [% END %]

    </div>
    <div class="tab-pane" id="tab_feeds">

            <ul class="nav nav-list">
              [% IF have_feeds %]
              [% FOREACH feed IN feeds %]
              <li id="li_feed[% feed.id %]"><a href="javascript:void(0)" onClick="showFeed([% feed.id %]);">[% feed.name | html %]</a></li>
              [% END %]
              [% END %]
            </ul>

    </div>
    <div class="tab-pane" id="tab_profile">

        <div class="well" id=profileBody></div>

    </div>
    </div>
  </div>

        <script>
        $.ajaxSetup ({  
            cache: false,
            async: false
        });

        function loadHtml(link, script) {
            var id = '#li_' + link;
            $(".active").removeClass("active");
            $(id).addClass("active");

            $("#htmlBody").load("/dashboard/html/" + link);
            $.getScript("/dashboard/javascript/" + link);
            if (script) {
                script = unescape(script);
                eval(script);
            }
        }

        function showProfile() {
            $("#profileBody").load("/dashboard/html/profile");
            $.getScript("/dashboard/javascript/profile");
        }

        function showEntry(link, feed_nbr, entry_id) {
            $("#htmlBody").remove();
            $(link.parentElement).append("<div id=htmlBody></div>");

            $("#htmlBody").load("/dashboard/feed/src/" + feed_nbr + "?entry_id=" + entry_id);

            [% UNLESS h.is_mobile %]
            tinymce.init({selector:'textarea', readonly: 1, menubar: "false", plugins: "fullscreen", toolbar: "fullscreen"});
            [% END %]
        }

        function showFeed(feed_nbr) {
            var id = '#li_feed' + feed_nbr;

            $("#feed_entries").remove();

            if ("active" == $(id).attr("class")) {
                $(id).removeClass("active");
                return;
            }

            $("li.active").removeClass("active");
            $(id).addClass("active");

            $.ajax({
                url: "/dashboard/feed/entries/" + feed_nbr,
                success: function(data) { 
                    $(id).append('<ol id=feed_entries>');
                    for (var i=0; i<data.length; i++) {
                        var entry = data[i];
                        var link = "<li><a href='javascript:void(0)' onClick=\"showEntry(" + feed_nbr + ", '" + entry.entry_id + "');\">" + entry.title + "</a>";
                        $('#feed_entries').append(link);
                    }
                    $(id).append('</ol>');
                },
            });
        }

        $('#main_tab a[href="#tab_profile"]').click(function (e) {
            e.preventDefault();
            $(this).tab('show');

            showProfile();
        })
        </script>

[% END %]
</body>
</html>
